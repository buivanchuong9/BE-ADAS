; ================================================
; ADAS v3.0 - Supervisor Configuration
; ================================================
; Location: ~/.supervisor/supervisord.conf
; Usage:
;   supervisord -c ~/.supervisor/supervisord.conf
;   supervisorctl -c ~/.supervisor/supervisord.conf status
;   supervisorctl -c ~/.supervisor/supervisord.conf restart adas-worker:*
; ================================================

[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
logfile=/hdd3/adas/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200
user=%(ENV_USER)s

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

; ================================================
; FastAPI Application
; ================================================
[program:adas-api]
command=/home/%(ENV_USER)s/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 52000 --workers 2
directory=/home/%(ENV_USER)s/backend-python/backend
user=%(ENV_USER)s
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/hdd3/adas/logs/api/api_stdout.log
stderr_logfile=/hdd3/adas/logs/api/api_stderr.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB
environment=
    DATABASE_URL="postgresql://adas:adas_secure_password@localhost:5432/adas_production",
    VIDEOS_RAW_DIR="/hdd3/adas/videos/raw",
    VIDEOS_OUTPUT_DIR="/hdd3/adas/videos/output",
    DEFAULT_DEVICE="cuda"

; ================================================
; GPU Workers (4 workers for A30 24GB)
; Each worker uses ~6GB VRAM
; ================================================
[program:adas-worker]
command=/home/%(ENV_USER)s/.venv/bin/python /home/%(ENV_USER)s/backend-python/workers/gpu_worker.py --worker-id worker_%(process_num)02d --device cuda
process_name=%(program_name)s_%(process_num)02d
numprocs=4
directory=/home/%(ENV_USER)s/backend-python
user=%(ENV_USER)s
autostart=true
autorestart=true
startsecs=30
startretries=3
stopwaitsecs=60
stdout_logfile=/hdd3/adas/logs/workers/worker_%(process_num)02d_stdout.log
stderr_logfile=/hdd3/adas/logs/workers/worker_%(process_num)02d_stderr.log
stdout_logfile_maxbytes=50MB
stderr_logfile_maxbytes=50MB
environment=
    CUDA_VISIBLE_DEVICES="0",
    DATABASE_URL="postgresql://adas:adas_secure_password@localhost:5432/adas_production",
    VIDEOS_RAW_DIR="/hdd3/adas/videos/raw",
    VIDEOS_OUTPUT_DIR="/hdd3/adas/videos/output"

; ================================================
; Job Recovery (runs every 5 minutes)
; Recovers stale jobs from dead workers
; ================================================
[program:adas-job-recovery]
command=/home/%(ENV_USER)s/.venv/bin/python -c "
import asyncio
import asyncpg
import time
import os

async def recover():
    conn = await asyncpg.connect(os.environ['DATABASE_URL'])
    while True:
        result = await conn.execute('''
            UPDATE job_queue 
            SET status = 'pending', worker_id = NULL, worker_heartbeat = NULL
            WHERE status = 'processing' 
            AND worker_heartbeat < NOW() - INTERVAL '15 minutes'
        ''')
        print(f'Recovered jobs: {result}')
        await asyncio.sleep(300)  # 5 minutes

asyncio.run(recover())
"
directory=/home/%(ENV_USER)s/backend-python
user=%(ENV_USER)s
autostart=true
autorestart=true
stdout_logfile=/hdd3/adas/logs/job_recovery.log
stderr_logfile=/hdd3/adas/logs/job_recovery_err.log
environment=DATABASE_URL="postgresql://adas:adas_secure_password@localhost:5432/adas_production"

; ================================================
; Group all ADAS processes
; ================================================
[group:adas]
programs=adas-api,adas-worker,adas-job-recovery
priority=999
